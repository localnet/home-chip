# @home-chip/registry

Home metadata that Matter does not provide.

## Responsibilities

- Custom device names and icons
- Zones / rooms management
- Favorites
- Device reconciliation after re-commissioning
- Domain repositories: `DeviceRepository`, `ZoneRepository`, `FavoriteRepository`

## Dependencies

Direct: `@home-chip/contract`, `@home-chip/database`, `@home-chip/system`

## Boundaries

Registry owns the **domain logic** for home metadata. It uses `@home-chip/database` for persistence but contains the repository implementations with business rules (e.g., reconciliation logic, zone assignment validation).

Repository interfaces (`DeviceRepository`, `ZoneRepository`, `FavoriteRepository`) are defined in `@home-chip/contract`. This package contains the concrete implementations. `core` receives them by constructor injection and interacts only through the interfaces.

## Device Identity and Reconciliation

HomeChip identifies devices internally by a `DeviceId` (UUID generated by HomeChip), not by the Matter `NodeId`. `NodeId` is assigned by the commissioner at commissioning time and wiped on factory reset, making it unsuitable as a stable identifier.

### Reconciliation lookup

When a newly commissioned device arrives, attempt to match it to an existing `DeviceId` using the Matter attributes stored at commissioning time. Execute lookups in order, stopping at first match:

1. `vendor_id + product_id + unique_id` WHERE `unique_id IS NOT NULL`
2. `vendor_id + product_id + serial_number` WHERE `serial_number IS NOT NULL`

If neither lookup yields a match, create a new `DeviceId`. No further steps apply.

### Match outcome

If a match is found, check the status of the candidate `DeviceId`:

- **Status is `connected`:** do not reconcile. Create a new `DeviceId`. Two active physical devices cannot share an identity.
- **Status is `disconnected`:** prompt the user to confirm. On confirmation, preserve the existing `DeviceId` and all metadata and update only the stored `NodeId`. On rejection, create a new `DeviceId`.

### Boundary

This logic lives exclusively in this package. `@home-chip/matter` reports commissioned devices with their Matter attributes; it has no knowledge of `DeviceId` or reconciliation.

## What Does NOT Belong Here

- Raw SQL or database connection management (belongs in `database`)
- Matter protocol interaction (belongs in `matter`)
- In-memory device state (belongs in `core`)
